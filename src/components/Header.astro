---
import HeaderLink from "./HeaderLink.astro";
import Logo from "./Logo.astro";
import { SITE_TITLE } from "../consts";
---

<header>
  <nav>
    <div class="header-nav">
      <div class="logo-container">
        <a href="/" class="logo-site-link">
          <Logo />
          <h2 class="site-title">
            {SITE_TITLE}
          </h2>
        </a>
      </div>
      <button
        class="hamburger-menu"
        aria-label="Toggle navigation menu"
        aria-expanded="false"
        aria-controls="overlay-menu"
      >
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
      <div class="navigation-links">
        <HeaderLink href="/">Home</HeaderLink>
        <HeaderLink href="/blog">Blog</HeaderLink>
        <div class="social-links">
          <a href="https://x.com/c_z_a_p_l_a" target="_blank">
            <span class="sr-only">Follow Michal on X</span>
            <svg viewBox="0 0 25 25" aria-hidden="true" width="32" height="32"
              ><path
                fill="currentColor"
                d="M13.982 10.622 20.54 3h-1.554l-5.693 6.618L8.745 3H3.5l6.876 10.007L3.5 21h1.554l6.012-6.989L15.868 21h5.245l-7.131-10.378Zm-2.128 2.474-.697-.997-5.543-7.93H8l4.474 6.4.697.996 5.815 8.318h-2.387l-4.745-6.787Z"
              ></path></svg
            >
          </a>
          <a href="https://github.com/michalczaplinski" target="_blank">
            <span class="sr-only">Go to Michal's GitHub repo</span>
            <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32"
              ><path
                fill="currentColor"
                d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"
              ></path></svg
            >
          </a>
          <a
            href="https://www.linkedin.com/in/michal-czaplinski/"
            target="_blank"
          >
            <span class="sr-only">Go to Michal's LinkedIn profile</span>
            <svg viewBox="0 0 24 24" aria-hidden="true" width="32" height="32">
              <path
                fill="currentColor"
                d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"
              ></path>
            </svg>
          </a>
        </div>
      </div>
    </div>
  </nav>
  <div id="overlay-menu" class="overlay-menu" aria-hidden="true">
    <button class="close-menu" aria-label="Close navigation menu">
      <svg
        viewBox="0 0 24 24"
        fill="none"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
    <div class="overlay-nav-links">
      <HeaderLink href="/">Home</HeaderLink>
      <HeaderLink href="/blog">Blog</HeaderLink>
      <div class="social-links">
        <a href="https://x.com/c_z_a_p_l_a" target="_blank">
          <span class="sr-only">Follow Michal on X</span>
          <svg viewBox="0 0 25 25" aria-hidden="true" width="32" height="32"
            ><path
              fill="currentColor"
              d="M13.982 10.622 20.54 3h-1.554l-5.693 6.618L8.745 3H3.5l6.876 10.007L3.5 21h1.554l6.012-6.989L15.868 21h5.245l-7.131-10.378Zm-2.128 2.474-.697-.997-5.543-7.93H8l4.474 6.4.697.996 5.815 8.318h-2.387l-4.745-6.787Z"
            ></path></svg
          >
        </a>
        <a href="https://github.com/michalczaplinski" target="_blank">
          <span class="sr-only">Go to Michal's GitHub repo</span>
          <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32"
            ><path
              fill="currentColor"
              d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"
            ></path></svg
          >
        </a>
        <a
          href="https://www.linkedin.com/in/michal-czaplinski/"
          target="_blank"
        >
          <span class="sr-only">Go to Michal's LinkedIn profile</span>
          <svg viewBox="0 0 24 24" aria-hidden="true" width="32" height="32">
            <path
              fill="currentColor"
              d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"
            ></path>
          </svg>
        </a>
      </div>
    </div>
  </div>
</header>
<style>
  body.menu-open {
    overflow: hidden;
  }

  header {
    margin: 0;
    padding: 1rem 2rem;
    border-bottom: 2px solid var(--border-color);
    background-color: var(--blueprint-blue);
    position: relative;
    z-index: 100;
  }

  .logo-site-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    align-self: center;

    h2 {
      margin-bottom: 0;
    }
  }

  /* Decorative corners for header */
  header::after {
    content: "";
    position: absolute;
    bottom: -6px;
    left: 20px;
    width: 10px;
    height: 10px;
    background: var(--blueprint-blue);
    border: 2px solid var(--border-color);
    transform: rotate(45deg);
  }

  header::before {
    content: "";
    position: absolute;
    bottom: -6px;
    right: 20px;
    width: 10px;
    height: 10px;
    background: var(--blueprint-blue);
    border: 2px solid var(--border-color);
    transform: rotate(45deg);
  }

  .logo-container {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 1rem;
  }

  /* Reset link styles inside header components that shouldn't look like text links */
  h2 a,
  .logo-container a {
    border-bottom: none;
  }

  h2 a:hover,
  .logo-container a:hover {
    background-color: transparent;
    box-shadow: none;
    color: var(--accent);
  }

  h2 {
    border-bottom: none; /* Remove h2 decorative underline */
    padding-bottom: 0;
    font-size: 1.5rem;
  }

  .site-title a {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-main);
  }

  .header-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .navigation-links {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  /* Ensure HeaderLinks don't get double borders from global a styles if problematic, 
     but HeaderLink.astro handles its own styles largely. */
  .navigation-links :global(a) {
    border-bottom: 2px solid transparent; /* Override global default */
  }

  .social-links {
    display: flex;
    gap: 1rem;
    margin-left: 1rem;
    padding-left: 1rem;
    border-left: 2px solid var(--blueprint-grid);
  }

  .social-links a {
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-main);
    border-bottom: none;
    width: 40px;
    height: 40px;
    border: 2px solid var(--border-color);
    transition: all 0.2s ease;
  }

  .social-links a:hover {
    background-color: var(--accent);
    color: var(--blueprint-blue);
    transform: translate(-2px, -2px);
    box-shadow: 4px 4px 0 var(--blueprint-grid);
  }

  .hamburger-menu {
    display: none;
    background: none;
    border: 2px solid var(--border-color);
    cursor: pointer;
    padding: 0.5rem;
    color: var(--text-main);
  }

  .hamburger-menu:hover {
    background-color: var(--accent);
    color: var(--blueprint-blue);
  }

  .hamburger-menu svg {
    width: 24px;
    height: 24px;
  }

  @media (max-width: 1080px) {
    .hamburger-menu {
      display: block;
    }

    .navigation-links {
      display: none;
    }
  }

  @media (max-width: 720px) {
    .site-title {
      display: none;
    }
  }

  /* Overlay Menu */
  .overlay-menu {
    position: fixed;
    top: 0;
    right: -100%;
    width: 100%;
    height: 100%;
    background-color: var(--blueprint-blue);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition:
      right 0.3s ease-in-out,
      visibility 0.3s;
    visibility: hidden;
    /* decorative grid overlay */
    background-image:
      linear-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
    background-size: 40px 40px;
  }

  .overlay-menu.menu-open {
    right: 0;
    visibility: visible;
  }

  .overlay-menu.closing {
    right: -100%;
    transition: right 0.25s ease-out;
    visibility: visible;
  }

  .close-menu {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    background: none;
    border: 2px solid var(--border-color);
    cursor: pointer;
    padding: 0.5rem;
    color: var(--text-main);
    transition: all 0.2s;
  }

  .close-menu:hover {
    background-color: var(--accent);
    color: var(--blueprint-blue);
  }

  .close-menu svg {
    width: 24px;
    height: 24px;
    stroke: currentColor;
  }

  .overlay-nav-links {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2rem;
  }

  .overlay-nav-links > :global(a) {
    font-size: 2rem;
    color: var(--text-main);
    text-decoration: none;
    padding: 1rem 2rem;
    border: 2px solid var(--border-color);
    text-transform: uppercase;
    font-weight: 900;
    background-color: rgba(0, 0, 0, 0.3);
  }

  .overlay-nav-links > :global(a:hover),
  .overlay-nav-links > :global(a.active) {
    color: var(--blueprint-blue);
    background-color: var(--accent);
    border-color: var(--accent);
  }

  .overlay-nav-links .social-links {
    margin: 0;
    padding: 0;
    border: none;
  }
</style>

<script>
  const hamburgerButton =
    document.querySelector<HTMLButtonElement>(".hamburger-menu");
  const closeButton = document.querySelector<HTMLButtonElement>(".close-menu");
  const overlayMenu = document.getElementById("overlay-menu");

  // Ensure overlayMenu exists before querying inside it
  if (hamburgerButton && closeButton && overlayMenu) {
    const navLinks = overlayMenu.querySelectorAll<HTMLAnchorElement>(
      ".overlay-nav-links a"
    ); // Get all links inside the overlay

    const focusableElements = [closeButton, ...Array.from(navLinks)]; // Convert NodeList to Array and ensure elements are focusable
    const firstFocusableElement = focusableElements[0] as HTMLElement; // Cast to HTMLElement
    const lastFocusableElement = focusableElements[
      focusableElements.length - 1
    ] as HTMLElement; // Cast to HTMLElement

    const openMenu = () => {
      overlayMenu.classList.add("menu-open");
      document.body.classList.add("menu-open"); // Prevent body scroll
      hamburgerButton.setAttribute("aria-expanded", "true");
      overlayMenu.setAttribute("aria-hidden", "false");
      // Delay focus slightly to allow transition to complete visually
      setTimeout(() => {
        firstFocusableElement.focus();
      }, 100); // Adjust delay if needed
    };

    const closeMenu = () => {
      // Add closing class to trigger animation
      overlayMenu.classList.add("closing");
      overlayMenu.classList.remove("menu-open"); // Keep open class removed for logic, but closing handles visual

      // Wait for animation to finish before hiding and resetting
      setTimeout(() => {
        overlayMenu.classList.remove("closing"); // Clean up class
        document.body.classList.remove("menu-open"); // Allow body scroll
        hamburgerButton.setAttribute("aria-expanded", "false");
        overlayMenu.setAttribute("aria-hidden", "true");
        (hamburgerButton as HTMLElement).focus(); // Cast and return focus
      }, 250); // Match CSS animation duration (250ms)
    };

    const handleKeyDown = (event: KeyboardEvent) => {
      // Add KeyboardEvent type
      if (
        event.key === "Escape" &&
        overlayMenu.classList.contains("menu-open")
      ) {
        closeMenu();
      }

      // Focus trapping logic
      if (event.key === "Tab" && overlayMenu.classList.contains("menu-open")) {
        if (event.shiftKey) {
          // Shift + Tab
          if (document.activeElement === firstFocusableElement) {
            lastFocusableElement.focus(); // Already cast
            event.preventDefault();
          }
        } else {
          // Tab
          if (document.activeElement === lastFocusableElement) {
            firstFocusableElement.focus(); // Already cast
            event.preventDefault();
          }
        }
      }
    };

    hamburgerButton.addEventListener("click", () => {
      const isExpanded =
        hamburgerButton.getAttribute("aria-expanded") === "true";
      if (isExpanded) {
        closeMenu();
      } else {
        openMenu();
      }
    });

    closeButton.addEventListener("click", closeMenu);

    document.addEventListener("keydown", handleKeyDown);
  } else {
    console.error("Header menu elements not found.");
  }
</script>
